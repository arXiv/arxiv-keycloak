services:
  cleanup-db:
    image: alpine:latest
    container_name: aaa-db-cleanup
    volumes:
      - ./mysql-data:/mysql-data
    command: sh -c "rm -rf /mysql-data/* && echo 'Cleaned mysql-data directory'"

  arxiv-test-db:
    image: mysql:8.4.5
    container_name: aaa-db-arxiv-test-db
    user: "${UID}:${GID}"
    ports:
      - "${ARXIV_DB_PORT}:${ARXIV_DB_PORT}"  # Host port:Container port
    volumes:
      - ./mysql-data:/var/lib/mysql  # Mount for snapshot/restore
    environment:
      MYSQL_ROOT_PASSWORD: root_password
      MYSQL_DATABASE: arXiv
      MYSQL_USER: arxiv
      MYSQL_PASSWORD: arxiv_password
      MYSQL_TCP_PORT: ${ARXIV_DB_PORT}
      PORT: ${ARXIV_DB_PORT}
    network_mode: host
    depends_on:
      cleanup-db:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-P", "${ARXIV_DB_PORT}", "--silent"]
      interval: 2s
      timeout: 2s
      retries: 15
      start_period: 30s

  myloader:
    image: mydumper/mydumper:latest
    container_name: aaa-db-myloader
    volumes:
      - ../../tests/data/test-db-dump:/myloader-data
    network_mode: host
    depends_on:
      arxiv-test-db:
        condition: service_healthy
    command:
      - myloader
      - --directory=/myloader-data
      - --host=127.0.0.1
      - --port=${ARXIV_DB_PORT}
      - --user=root
      - --password=root_password
      - --overwrite-tables
