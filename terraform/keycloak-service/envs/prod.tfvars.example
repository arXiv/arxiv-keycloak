# Production environment configuration
# Copy this file to prod.tfvars and customize for your production environment

gcp_project_id = "arxiv-production"
gcp_region     = "us-central1"
environment    = "production"

# Database configuration
# These MUST come from the keycloak-db module outputs
# Do NOT hardcode these values - pass via CLI:
#   terraform apply \
#     -var="auth_db_private_ip=$(cd ../keycloak-db && terraform output -raw private_ip_address)" \
#     -var="auth_db_name=$(cd ../keycloak-db && terraform output -raw database_name)" \
#     -var="db_user=$(cd ../keycloak-db && terraform output -raw keycloak_user_name)"

# Keycloak database user password - auto-generated and stored in Secret Manager
# Leave empty to auto-generate a secure random password
# keycloak_db_password = ""

# Keycloak image
keycloak_image = "us-central1-docker.pkg.dev/arxiv-production/arxiv-docker/keycloak-service:latest"

# Cloud Run service configuration
min_instances = "2"
max_instances = "10"
cpu_limit     = "2"
memory_limit  = "4Gi"
timeout_seconds = 300
container_concurrency = 80
container_port = 8080

# Performance settings
cpu_boost        = true
session_affinity = true
vpc_egress       = "private-ranges-only"

# Backend and health check configuration
backend_timeout_sec = 300
enable_health_check = true
health_check_timeout = 5
health_check_interval = 30
health_check_path = "/health/ready"

# Secrets (to be mounted)
secrets = {
  # Database SSL certificates
  # NOTE: This secret contains a shell script that outputs certificate files.
  # At startup, Keycloak runs: cd /home/keycloak/certs && sh /secrets/authdb-certs/db-certs-expand.sh
  # This is a workaround since Cloud Run doesn't support mounting multiple files from one secret.
  authdb_certs = {
    secret_name = "authdb-certs"
    version     = "latest"
    mount_path  = "/secrets/authdb-certs/db-certs-expand.sh"
  }
  keycloak_admin_password = {
    secret_name = "keycloak-admin-password"
    version     = "latest"
    mount_path  = null
  }
  gcp_credentials = {
    secret_name = "keycloak-pubsub-event-sa"
    version     = "latest"
    mount_path  = null
  }
}

# Environment variables
additional_env_vars = {
  # Keycloak startup mode: "start-dev" (development) or "start" (production)
  KEYCLOAK_START                = "start"
  PROXY_MODE                    = "--proxy-headers=forwarded"
  KC_BOOTSTRAP_ADMIN_USERNAME   = "admin"
  BOOTSTRAP                     = "no"
  LOG_OUTPUT_FORMAT             = "--log-console-output=json"
  GCP_PROJECT_ID                = "arxiv-production"
  KC_PORT                       = "8080"
  GRPC_LOG_LEVEL                = "INFO"
  GRPC_TRACE                    = ""
  ARXIV_USER_REGISTRATION_URL   = "https://arxiv.org/user-account/register"
  # Keycloak audit event publishing to GCP Pub/Sub (via SPI plugin)
  GCP_EVENT_TOPIC_ID            = "keycloak-arxiv-events"
  GCP_ADMIN_EVENT_TOPIC_ID      = "keycloak-arxiv-events"
}

# HTTPS and SSL certificate configuration
# Enable HTTPS with Google-managed SSL certificate
enable_https = true
domain_names = ["auth.arxiv.org"]
